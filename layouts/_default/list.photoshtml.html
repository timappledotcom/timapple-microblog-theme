{{ define "main" }}
<main class="container container-wide">

  {{/* Page Description */}}
  <header class="page-header" style="text-align: center; margin-top: var(--spacing-lg);">
    <p class="page-description" style="font-style: italic; color: var(--color-ink-light);">A visual journal</p>
  </header>

  {{/* Photos Grid - matches Micro.blog default structure */}}
  <div class="photos-grid-container" style="display: grid; grid-column-gap: 15px; grid-row-gap: 15px; grid-template-columns: repeat(3, 1fr);">

    {{/* Posts with .Params.photos (uploaded via Micro.blog's photo feature) */}}
    {{- $list := where .Site.Pages ".Params.photos" "!=" nil -}}
    {{ range $list }}
      <a href="{{ .Permalink }}">
        {{ range first 1 .Params.photos }}
          <img src="{{ . }}" width="300" height="300" style="border-radius: 5px; max-width: 100%; height: auto; object-fit: cover;" class="photos-grid-item" loading="lazy" />
        {{ end }}
      </a>
    {{ end }}

    {{/* Fallback: find posts with images embedded in content */}}
    {{ $allPosts := where .Site.RegularPages "Type" "post" }}
    {{ range $allPosts }}
      {{ if not .Params.photos }}
        {{/* Look for img tags in rendered content */}}
        {{ $images := findRE `<img[^>]+>` .Content }}
        {{ if $images }}
          {{ $firstImg := index $images 0 }}
          {{ $srcMatches := findRE `src=["']([^"']+)["']` $firstImg }}
          {{ if $srcMatches }}
            {{ $srcAttr := index $srcMatches 0 }}
            {{ $src := replaceRE `src=["']` "" $srcAttr }}
            {{ $src = replaceRE `["']$` "" $src }}
            <a href="{{ .Permalink }}">
              <img src="{{ $src }}" width="300" height="300" style="border-radius: 5px; max-width: 100%; height: auto; object-fit: cover;" class="photos-grid-item" loading="lazy" />
            </a>
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}

  </div>

</main>
{{ end }}